import { render, screen } from "@testing-library/react";
import { VulnerabilityTable } from "../scan/VulnerabilityTable";
import type { ExploitMatch } from "@/lib/types";

const mockMatches: ExploitMatch[] = [
  {
    pattern_id: "SOL-001",
    name: "Missing Signer Check",
    category: "access_control",
    severity: "critical",
    confidence: 0.95,
    cwe: "CWE-284",
    indicators_matched: ["no_signer_annotation", "mutable_without_check"],
  },
  {
    pattern_id: "SOL-002",
    name: "Unsafe CPI",
    category: "cross_program",
    severity: "high",
    confidence: 0.7,
    cwe: null,
    indicators_matched: ["invoke_unchecked"],
  },
];

describe("VulnerabilityTable", () => {
  it("renders empty state when no matches", () => {
    render(<VulnerabilityTable matches={[]} />);
    expect(
      screen.getByText("No exploit patterns detected")
    ).toBeInTheDocument();
  });

  it("renders table headers", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("Pattern")).toBeInTheDocument();
    expect(screen.getByText("Category")).toBeInTheDocument();
    expect(screen.getByText("Severity")).toBeInTheDocument();
    expect(screen.getByText("Confidence")).toBeInTheDocument();
    expect(screen.getByText("CWE")).toBeInTheDocument();
  });

  it("renders match names", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("Missing Signer Check")).toBeInTheDocument();
    expect(screen.getByText("Unsafe CPI")).toBeInTheDocument();
  });

  it("renders severity badges", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("critical")).toBeInTheDocument();
    expect(screen.getByText("high")).toBeInTheDocument();
  });

  it("renders confidence as percentage", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("95%")).toBeInTheDocument();
    expect(screen.getByText("70%")).toBeInTheDocument();
  });

  it("renders CWE when available", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("CWE-284")).toBeInTheDocument();
  });

  it("renders -- when CWE is null", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("--")).toBeInTheDocument();
  });

  it("renders indicator list", () => {
    render(<VulnerabilityTable matches={mockMatches} />);
    expect(screen.getByText("no_signer_annotation")).toBeInTheDocument();
    expect(screen.getByText("mutable_without_check")).toBeInTheDocument();
  });
});
