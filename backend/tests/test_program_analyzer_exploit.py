"""Tests for program_analyzer exploit pattern matching and rug similarity."""

from unittest.mock import MagicMock, patch

import pytest

from nile.services.program_analyzer import SolanaProgramAnalyzer, _load_exploit_patterns


@pytest.fixture(autouse=True)
def _reset_patterns():
    """Reset cached exploit patterns between tests."""
    import nile.services.program_analyzer as mod

    mod._EXPLOIT_PATTERNS = []
    yield
    mod._EXPLOIT_PATTERNS = []


MOCK_PATTERNS = [
    {
        "id": "SOL-001",
        "name": "Missing Signer Check",
        "category": "access_control",
        "severity": "critical",
        "cwe": "CWE-284",
        "indicators": ["Missing signer verification", "No authority check"],
    },
    {
        "id": "SOL-002",
        "name": "Unvalidated Accounts",
        "category": "account_validation",
        "severity": "high",
        "cwe": "CWE-20",
        "indicators": ["No owner validation check", "Missing account verification"],
    },
    {
        "id": "SOL-003",
        "name": "Rug Pull Risk",
        "category": "rug_pull",
        "severity": "critical",
        "indicators": ["Upgrade authority active", "No verified source code"],
    },
    {
        "id": "SOL-004",
        "name": "Unsafe CPI",
        "category": "cross_program",
        "severity": "high",
        "indicators": [],
    },
    {
        "id": "SOL-005",
        "name": "Signature Bypass",
        "category": "signature_verification",
        "severity": "high",
        "indicators": [],
    },
    {
        "id": "SOL-006",
        "name": "Oracle Manipulation",
        "category": "oracle_manipulation",
        "severity": "medium",
        "indicators": [],
    },
]


class TestMatchExploitPatterns:
    def test_access_control_match(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"missing_signer_checks": 2, "has_idl": True}
            matches = analyzer._match_exploit_patterns(idl, None)
            ac_matches = [m for m in matches if m["category"] == "access_control"]
            assert len(ac_matches) == 1
            assert ac_matches[0]["confidence"] > 0.3

    def test_account_validation_match(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"unvalidated_accounts": 3, "has_idl": True}
            matches = analyzer._match_exploit_patterns(idl, None)
            av_matches = [m for m in matches if m["category"] == "account_validation"]
            assert len(av_matches) == 1

    def test_rug_pull_match_upgradeable_no_idl(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"has_idl": False}
            authority = {"upgradeable": True}
            matches = analyzer._match_exploit_patterns(idl, authority)
            rug_matches = [m for m in matches if m["category"] == "rug_pull"]
            assert len(rug_matches) == 1
            assert rug_matches[0]["confidence"] >= 0.5

    def test_cross_program_match(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"unsafe_cpi_calls": 2}
            matches = analyzer._match_exploit_patterns(idl, None)
            cpi_matches = [m for m in matches if m["category"] == "cross_program"]
            assert len(cpi_matches) == 1

    def test_signature_verification_match(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"missing_signer_checks": 3}
            matches = analyzer._match_exploit_patterns(idl, None)
            sig_matches = [m for m in matches if m["category"] == "signature_verification"]
            assert len(sig_matches) == 1
            assert sig_matches[0]["confidence"] == 0.4

    def test_oracle_manipulation_no_match(self):
        """Oracle manipulation always returns 0 confidence â€” never matches."""
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            idl = {"has_idl": True}
            matches = analyzer._match_exploit_patterns(idl, None)
            oracle_matches = [m for m in matches if m["category"] == "oracle_manipulation"]
            assert len(oracle_matches) == 0

    def test_no_patterns_loaded(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=[],
        ):
            matches = analyzer._match_exploit_patterns({}, None)
            assert matches == []


class TestMatchedIndicators:
    def test_access_control_indicators(self):
        analyzer = SolanaProgramAnalyzer()
        pattern = MOCK_PATTERNS[0]  # access_control
        idl = {"missing_signer_checks": 1}
        matched = analyzer._matched_indicators(pattern, idl, None)
        assert "Missing signer verification" in matched

    def test_account_validation_indicators(self):
        analyzer = SolanaProgramAnalyzer()
        pattern = MOCK_PATTERNS[1]  # account_validation
        idl = {"unvalidated_accounts": 1}
        matched = analyzer._matched_indicators(pattern, idl, None)
        assert any("validation" in m.lower() or "check" in m.lower() for m in matched)

    def test_rug_pull_indicators(self):
        analyzer = SolanaProgramAnalyzer()
        pattern = MOCK_PATTERNS[2]  # rug_pull
        idl = {"has_idl": False}
        authority = {"upgradeable": True}
        matched = analyzer._matched_indicators(pattern, idl, authority)
        assert "Upgrade authority active (single signer)" in matched
        assert "No verified source" in matched


class TestMatchTokenExploitPatterns:
    def test_token_rug_with_mint_and_freeze(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            token_info = {
                "mint_authority_active": True,
                "freeze_authority_active": True,
            }
            matches = analyzer._match_token_exploit_patterns(token_info)
            assert len(matches) == 1
            assert matches[0]["category"] == "rug_pull"
            assert "Mint authority not revoked" in matches[0]["indicators_matched"]
            assert "Freeze authority active" in matches[0]["indicators_matched"]

    def test_token_safe_no_match(self):
        analyzer = SolanaProgramAnalyzer()
        with patch(
            "nile.services.program_analyzer._load_exploit_patterns",
            return_value=MOCK_PATTERNS,
        ):
            token_info = {
                "mint_authority_active": False,
                "freeze_authority_active": False,
            }
            matches = analyzer._match_token_exploit_patterns(token_info)
            assert len(matches) == 0


class TestComputeRugSimilarity:
    def test_high_risk_token(self):
        analyzer = SolanaProgramAnalyzer()
        token_info = {
            "mint_authority_active": True,
            "freeze_authority_active": True,
            "supply": 100,
            "decimals": 6,
        }
        score = analyzer._compute_rug_similarity(token_info)
        # 0.35 + 0.25 + 0.1 (low supply) = 0.70
        assert score >= 0.7

    def test_safe_token(self):
        analyzer = SolanaProgramAnalyzer()
        token_info = {
            "mint_authority_active": False,
            "freeze_authority_active": False,
            "supply": 1000000000,
            "decimals": 6,
        }
        score = analyzer._compute_rug_similarity(token_info)
        assert score == 0.0

    def test_partial_risk(self):
        analyzer = SolanaProgramAnalyzer()
        token_info = {
            "mint_authority_active": True,
            "freeze_authority_active": False,
            "supply": 10000000000,
            "decimals": 6,
        }
        score = analyzer._compute_rug_similarity(token_info)
        assert score == 0.35


class TestLoadExploitPatterns:
    def test_patterns_not_found(self):
        import nile.services.program_analyzer as mod

        mod._EXPLOIT_PATTERNS = []
        mock_path = MagicMock()
        mock_path.read_text.side_effect = FileNotFoundError
        with patch.object(mod, "_EXPLOIT_PATTERNS_PATH", mock_path):
            result = _load_exploit_patterns()
            assert result == []

    def test_patterns_cached(self):
        import nile.services.program_analyzer as mod

        mod._EXPLOIT_PATTERNS = [{"id": "cached"}]
        result = _load_exploit_patterns()
        assert result == [{"id": "cached"}]
