"""Vulnerability findings model."""

import uuid
from datetime import UTC, datetime

from sqlalchemy import JSON, DateTime, ForeignKey, Integer, Numeric, String, Text, Uuid, func
from sqlalchemy.orm import Mapped, mapped_column, relationship

from nile.models.base import Base, UUIDMixin


class Vulnerability(UUIDMixin, Base):
    __tablename__ = "vulnerabilities"

    contract_id: Mapped[uuid.UUID] = mapped_column(
        Uuid, ForeignKey("contracts.id"), nullable=False, index=True
    )
    scan_job_id: Mapped[uuid.UUID | None] = mapped_column(Uuid, ForeignKey("scan_jobs.id"))

    title: Mapped[str] = mapped_column(Text, nullable=False)
    severity: Mapped[str] = mapped_column(String(16), nullable=False, index=True)
    category: Mapped[str] = mapped_column(String(64), nullable=False, index=True)

    description: Mapped[str | None] = mapped_column(Text)
    impact: Mapped[str | None] = mapped_column(Text)
    proof_of_concept: Mapped[str | None] = mapped_column(Text)
    remediation: Mapped[str | None] = mapped_column(Text)

    # Code references
    file_path: Mapped[str | None] = mapped_column(Text)
    line_start: Mapped[int | None] = mapped_column(Integer)
    line_end: Mapped[int | None] = mapped_column(Integer)

    # Scoring
    confidence: Mapped[float | None] = mapped_column(Numeric(3, 2))
    exploitability_score: Mapped[float | None] = mapped_column(Numeric(5, 2))

    # Benchmark alignment
    benchmark_vuln_id: Mapped[str | None] = mapped_column(String(32))
    benchmark_audit_id: Mapped[str | None] = mapped_column(String(64))

    # Status
    status: Mapped[str] = mapped_column(String(16), default="open")
    patched_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True))

    detected_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        default=lambda: datetime.now(UTC),
        server_default=func.now(),
    )
    metadata_: Mapped[dict] = mapped_column("metadata", JSON, default=dict)

    # Relationships
    contract = relationship("Contract", back_populates="vulnerabilities")
    scan_job = relationship("ScanJob", back_populates="vulnerabilities")
